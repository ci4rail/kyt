# ===================================================
# mounts
# ===================================================
mount=mount-kyt-api-server-src:
  bind: "kyt-api-server/"
  path: "/home/user/src"
  read-only: true

mount=mount-kyt-api-server-bin:
  bind: "bin/"
  path: "/home/user/bin"
  read-only: false

mount=mount-kyt-api-server-src-gen:
  bind: "kyt-api-server/"
  path: "/local"
  read-only: false

mount=mount-api-spec:
  bind: "kyt-api-spec/"
  path: "/spec"
  read-only: true


image=image-openapi-generator:
  image: openapitools/openapi-generator-cli
  tags: ["v5.0.0"]
  pull: once


# ===================================================
# jobs
# ===================================================
job=build-server-sources:
  use: image-openapi-generator
  command: generate -i /spec/kytapi.yaml -g go-gin-server -o /local
  mounts:
    - mount-api-spec
    - mount-kyt-api-server-src-gen
  sources:
    - kyt-api-spec/kytapi.yaml
  artifact:
    - kyt-api-server/main.go
  annotations:
    description: "-> build kyt-api-server sources"
    tags:
      - generate-sources

job=build-kyt-api-server:
  use: image-kyt-go-builder
  command: bash -c 'cd src && GOOS=linux GOARCH=386 go build -o ../bin/kyt-api-server main.go'
  mounts:
    - mount-kyt-api-server-src
    - mount-kyt-api-server-bin
  sources:
    - kyt-api-server
  artifact:
    - bin
  env:
    - USERID={user.uid}
    - GROUPID={user.gid}
  annotations:
    description: "-> build kyt-api-server"
    tags:
      - build
