# ===================================================
# mounts
# ===================================================
mount=mount-kyt-api-server-src:
  bind: "kyt-api-server/"
  path: "/src"
  read-only: false

mount=mount-kyt-api-server-bin:
  bind: "bin/"
  path: "/install"
  read-only: false

# ===================================================
# jobs
# ===================================================

job=generate-server-sources:
  use: image-openapi-generator
  command: generate -i /kyt-api-spec/kytapi.yaml -g go-gin-server -o /src
           -t /project/openapi-generator/templates/go-gin-server --additional-properties apiPath=openapi
  mounts:
    - mount-project-root
    - mount-kyt-api-spec
    - mount-kyt-api-server-src
  sources:
    - kyt-api-spec/kytapi.yaml
  artifact:
    - kyt-api-server/openapi/routers.go
  user: "{user.uid}:{user.gid}"
  annotations:
    description: "-> generate kyt-api-server sources"
    tags:
      - generate-sources

job=build-kyt-api-server:
  use: image-go-builder
  command: bash -c 'cd /src && make -j${nproc}'
  # command: bash
  # interactive: true
  mounts:
    - mount-kyt-api-server-src
    - mount-kyt-api-server-bin
  depends:
    - generate-server-sources
  sources:
    - kyt-api-server
  artifact:
    - bin/kyt-api-server
  user: "{user.uid}:{user.gid}"
  env:
    - BIN_DIR=/install
    - GOCACHE=/tmp/cache
  annotations:
    description: "-> build kyt-api-server"
    tags:
      - build
